{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Actions for webservice manager tool.\n *\n * @module     tool_wsmanager/actions\n * @copyright  Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalForm from 'core_form/modalform';\nimport {getString} from 'core/str';\nimport * as reportEvents from 'core_reportbuilder/local/events';\nimport * as reportSelectors from 'core_reportbuilder/local/selectors';\nimport {dispatchEvent} from 'core/event_dispatcher';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\nconst SELECTORS = {\n    EDITSERVICES: '[data-action=\"tool_wsmanager-edit-services\"][data-function]',\n    EDITDESCRIPTION: '[data-action=\"tool_wsmanager-edit-description\"][data-function]',\n    bulkActionsForm: 'form#tool_wsmanager-bulk-actions-form',\n    reportWrapper: '[data-region=\"tool_wsfunction-list-wrapper\"]',\n    checkedRows: '[data-togglegroup=\"report-select-all\"][data-toggle=\"slave\"]:checked',\n};\n\n/**\n * Initialize module.\n */\nexport function init() {\n\n    document.addEventListener('click', event => {\n\n        // Edit services for the function.\n        const editServices = event.target.closest(SELECTORS.EDITSERVICES);\n        if (editServices) {\n            event.preventDefault();\n            showFunctionModalForm(editServices,\n                getString('editservices', 'tool_wsmanager'),\n                'tool_wsmanager\\\\form\\\\function_services_form');\n        }\n\n        // Edit description/tags for the function.\n        const editDescription = event.target.closest(SELECTORS.EDITDESCRIPTION);\n        if (editDescription) {\n            event.preventDefault();\n            showFunctionModalForm(editDescription,\n                getString('editdetails', 'tool_wsmanager'),\n                'tool_wsmanager\\\\form\\\\edit_function_form');\n        }\n    });\n\n    const bulkForm = document.querySelector(SELECTORS.bulkActionsForm);\n    const reportElement = bulkForm?.closest(SELECTORS.reportWrapper)?.querySelector(reportSelectors.regions.report);\n    if (bulkForm && reportElement) {\n        const actionSelect = bulkForm.querySelector('select');\n        actionSelect.addEventListener('change', event => {\n            event.preventDefault();\n            const value = event.target.value;\n            if (value !== '0') {\n                const functionNames = [...reportElement.querySelectorAll(SELECTORS.checkedRows)].map(v => v.value);\n                window.console.log('onChange', event.target.value, functionNames);\n                event.target.value = '0';\n                if (functionNames.length > 0) {\n                    performBulkAction(actionSelect, reportElement, value, functionNames);\n                }\n            }\n        });\n    }\n}\n\n/**\n * Perform bulk action\n *\n * @param {Element} actionSelect\n * @param {Element} reportElement\n * @param {String} actionValue\n * @param {Array} functionNames\n */\nasync function performBulkAction(actionSelect, reportElement, actionValue, functionNames) {\n\n    var arr = actionValue.match(/^(add|remove)-service-(\\d+)$/);\n    if (arr) {\n        // TODO confirmation?\n        const request = {\n            methodname: 'tool_wsmanager_add_function_to_service',\n            args: {functionnames: functionNames, serviceid: parseInt(arr[2]), action: arr[1]}\n        };\n        Ajax.call([request])[0]\n            .then(() => {\n                dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n                return null;\n            })\n            .catch((e) => Notification.exception(e));\n    }\n    if (actionValue == 'add-tag') {\n        showTagsModalForm(\n            actionSelect,\n            reportElement,\n            {functionnames: functionNames.join(','), action: 'add'},\n            getString('addtag', 'tool_wsmanager'),\n        );\n    }\n    if (actionValue == 'remove-tag') {\n        showTagsModalForm(\n            actionSelect,\n            reportElement,\n            {functionnames: functionNames.join(','), action: 'remove'},\n            getString('removetag', 'tool_wsmanager'),\n        );\n    }\n}\n\n/**\n * Show modal form for editing a function\n *\n * @param {Element} targetElement\n * @param {Promise} title\n * @param {String} formClass\n */\nfunction showFunctionModalForm(targetElement, title, formClass) {\n    const functionname = targetElement.dataset.function;\n\n    const modalForm = new ModalForm({\n        modalConfig: {title},\n        formClass,\n        args: {functionname},\n        saveButtonText: getString('savechanges', 'moodle'),\n        returnFocus: targetElement,\n    });\n\n    // Reload report when the form is submitted.\n    const reportElement = targetElement.closest(reportSelectors.regions.report);\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n        dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n    });\n\n    modalForm.show();\n}\n\n/**\n * Show modal form for tags bulk actions\n *\n * @param {Element} actionSelect\n * @param {Element} reportElement\n * @param {Object} args\n * @param {String} title\n */\nfunction showTagsModalForm(actionSelect, reportElement, args, title) {\n\n    const modalForm = new ModalForm({\n        modalConfig: {title},\n        formClass: 'tool_wsmanager\\\\form\\\\change_tags_form',\n        args,\n        saveButtonText: getString('savechanges', 'moodle'),\n        returnFocus: actionSelect,\n    });\n\n    // Reload report when the form is submitted.\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n        dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n    });\n\n    modalForm.show();\n}"],"names":["document","addEventListener","event","editServices","target","closest","SELECTORS","preventDefault","showFunctionModalForm","editDescription","bulkForm","querySelector","reportElement","_bulkForm$closest","reportSelectors","regions","report","actionSelect","value","functionNames","querySelectorAll","map","v","window","console","log","length","actionValue","arr","match","request","methodname","args","functionnames","serviceid","parseInt","action","call","then","reportEvents","tableReload","preservePagination","catch","e","Notification","exception","showTagsModalForm","join","performBulkAction","targetElement","title","formClass","functionname","dataset","function","modalForm","ModalForm","modalConfig","saveButtonText","returnFocus","events","FORM_SUBMITTED","show"],"mappings":";;;;;;;4GA4CIA,SAASC,iBAAiB,SAASC,cAGzBC,aAAeD,MAAME,OAAOC,QAAQC,wBACtCH,eACAD,MAAMK,iBACNC,sBAAsBL,cAClB,kBAAU,eAAgB,kBAC1B,uDAIFM,gBAAkBP,MAAME,OAAOC,QAAQC,2BACzCG,kBACAP,MAAMK,iBACNC,sBAAsBC,iBAClB,kBAAU,cAAe,kBACzB,sDAINC,SAAWV,SAASW,cAAcL,2BAClCM,cAAgBF,MAAAA,oCAAAA,SAAUL,QAAQC,6DAAlBO,kBAA4CF,cAAcG,gBAAgBC,QAAQC,WACpGN,UAAYE,cAAe,OACrBK,aAAeP,SAASC,cAAc,UAC5CM,aAAahB,iBAAiB,UAAUC,QACpCA,MAAMK,uBACAW,MAAQhB,MAAME,OAAOc,SACb,MAAVA,MAAe,OACTC,cAAgB,IAAIP,cAAcQ,iBAAiBd,wBAAwBe,KAAIC,GAAKA,EAAEJ,QAC5FK,OAAOC,QAAQC,IAAI,WAAYvB,MAAME,OAAOc,MAAOC,eACnDjB,MAAME,OAAOc,MAAQ,IACjBC,cAAcO,OAAS,kBAgBVT,aAAcL,cAAee,YAAaR,mBAEnES,IAAMD,YAAYE,MAAM,mCACxBD,IAAK,OAECE,QAAU,CACZC,WAAY,yCACZC,KAAM,CAACC,cAAed,cAAee,UAAWC,SAASP,IAAI,IAAKQ,OAAQR,IAAI,mBAE7ES,KAAK,CAACP,UAAU,GAChBQ,MAAK,yCACYC,aAAaC,YAAa,CAACC,oBAAoB,GAAO7B,eAC7D,QAEV8B,OAAOC,GAAMC,sBAAaC,UAAUF,KAE1B,WAAfhB,aACAmB,kBACI7B,aACAL,cACA,CAACqB,cAAed,cAAc4B,KAAK,KAAMX,OAAQ,QACjD,kBAAU,SAAU,mBAGT,cAAfT,aACAmB,kBACI7B,aACAL,cACA,CAACqB,cAAed,cAAc4B,KAAK,KAAMX,OAAQ,WACjD,kBAAU,YAAa,mBA5CfY,CAAkB/B,aAAcL,cAAeM,MAAOC,6QA9CpEb,uBACY,8DADZA,0BAEe,iEAFfA,0BAGe,wCAHfA,wBAIa,+CAJbA,sBAKW,+EAiGRE,sBAAsByC,cAAeC,MAAOC,iBAC3CC,aAAeH,cAAcI,QAAQC,SAErCC,UAAY,IAAIC,mBAAU,CAC5BC,YAAa,CAACP,MAAAA,OACdC,UAAAA,UACAnB,KAAM,CAACoB,aAAAA,cACPM,gBAAgB,kBAAU,cAAe,UACzCC,YAAaV,gBAIXrC,cAAgBqC,cAAc5C,QAAQS,gBAAgBC,QAAQC,QACpEuC,UAAUtD,iBAAiBsD,UAAUK,OAAOC,gBAAgB,yCAC1CtB,aAAaC,YAAa,CAACC,oBAAoB,GAAO7B,kBAGxE2C,UAAUO,gBAWLhB,kBAAkB7B,aAAcL,cAAeoB,KAAMkB,aAEpDK,UAAY,IAAIC,mBAAU,CAC5BC,YAAa,CAACP,MAAAA,OACdC,UAAW,yCACXnB,KAAAA,KACA0B,gBAAgB,kBAAU,cAAe,UACzCC,YAAa1C,eAIjBsC,UAAUtD,iBAAiBsD,UAAUK,OAAOC,gBAAgB,yCAC1CtB,aAAaC,YAAa,CAACC,oBAAoB,GAAO7B,kBAGxE2C,UAAUO"}