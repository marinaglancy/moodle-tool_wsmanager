{"version":3,"file":"actions.min.js","sources":["../src/actions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Actions for webservice manager tool.\n *\n * @module     tool_wsmanager/actions\n * @copyright  Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalForm from 'core_form/modalform';\nimport {getString} from 'core/str';\nimport * as reportEvents from 'core_reportbuilder/local/events';\nimport * as reportSelectors from 'core_reportbuilder/local/selectors';\nimport {dispatchEvent} from 'core/event_dispatcher';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport Modal from 'core/modal_cancel';\n\nconst SELECTORS = {\n    EDITSERVICES: '[data-action=\"tool_wsmanager-edit-services\"][data-function]',\n    EDITDESCRIPTION: '[data-action=\"tool_wsmanager-edit-description\"][data-function]',\n    viewDetails: '[data-action=\"tool_wsmanager-view-details\"][data-function]',\n    bulkActionsForm: 'form#tool_wsmanager-bulk-actions-form',\n    reportWrapper: '[data-region=\"tool_wsfunction-list-wrapper\"]',\n    checkedRows: '[data-togglegroup=\"report-select-all\"][data-toggle=\"slave\"]:checked',\n};\n\n/**\n * Initialize module.\n */\nexport function init() {\n\n    document.addEventListener('click', event => {\n\n        // Edit services for the function.\n        const editServices = event.target.closest(SELECTORS.EDITSERVICES);\n        if (editServices) {\n            event.preventDefault();\n            showFunctionModalForm(editServices,\n                getString('editservices', 'tool_wsmanager'),\n                'tool_wsmanager\\\\form\\\\function_services_form');\n        }\n\n        // Edit description/tags for the function.\n        const editDescription = event.target.closest(SELECTORS.EDITDESCRIPTION);\n        if (editDescription) {\n            event.preventDefault();\n            showFunctionModalForm(editDescription,\n                getString('editdetails', 'tool_wsmanager'),\n                'tool_wsmanager\\\\form\\\\edit_function_form');\n        }\n\n        // Edit description/tags for the function.\n        const viewDetails = event.target.closest(SELECTORS.viewDetails);\n        if (viewDetails) {\n            event.preventDefault();\n            showFunctionDetails(viewDetails);\n        }\n    });\n\n    const bulkForm = document.querySelector(SELECTORS.bulkActionsForm);\n    const reportElement = bulkForm?.closest(SELECTORS.reportWrapper)?.querySelector(reportSelectors.regions.report);\n    if (bulkForm && reportElement) {\n        const actionSelect = bulkForm.querySelector('select');\n        actionSelect.addEventListener('change', event => {\n            event.preventDefault();\n            const value = event.target.value;\n            if (value !== '0') {\n                const functionNames = [...reportElement.querySelectorAll(SELECTORS.checkedRows)].map(v => v.value);\n                event.target.value = '0';\n                if (functionNames.length > 0) {\n                    performBulkAction(actionSelect, reportElement, value, functionNames);\n                }\n            }\n        });\n    }\n}\n\n/**\n * Perform bulk action\n *\n * @param {Element} actionSelect\n * @param {Element} reportElement\n * @param {String} actionValue\n * @param {Array} functionNames\n */\nasync function performBulkAction(actionSelect, reportElement, actionValue, functionNames) {\n\n    var arr = actionValue.match(/^(add|remove)-service-(\\d+)$/);\n    if (arr) {\n        // TODO ask for confirmation?\n        const request = {\n            methodname: 'tool_wsmanager_add_function_to_service',\n            args: {functionnames: functionNames, serviceid: parseInt(arr[2]), action: arr[1]}\n        };\n        Ajax.call([request])[0]\n            .then(() => {\n                dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n                return null;\n            })\n            .catch((e) => Notification.exception(e));\n    }\n    if (actionValue == 'add-tag') {\n        showTagsModalForm(\n            actionSelect,\n            reportElement,\n            {functionnames: functionNames.join(','), action: 'add'},\n            getString('addtag', 'tool_wsmanager'),\n        );\n    }\n    if (actionValue == 'remove-tag') {\n        showTagsModalForm(\n            actionSelect,\n            reportElement,\n            {functionnames: functionNames.join(','), action: 'remove'},\n            getString('removetag', 'tool_wsmanager'),\n        );\n    }\n}\n\n/**\n * Show modal form for editing a function\n *\n * @param {Element} targetElement\n * @param {Promise} title\n * @param {String} formClass\n */\nfunction showFunctionModalForm(targetElement, title, formClass) {\n    const functionname = targetElement.dataset.function;\n\n    const modalForm = new ModalForm({\n        modalConfig: {title},\n        formClass,\n        args: {functionname},\n        saveButtonText: getString('savechanges', 'moodle'),\n        returnFocus: targetElement,\n    });\n\n    // Reload report when the form is submitted.\n    const reportElement = targetElement.closest(reportSelectors.regions.report);\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n        dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n    });\n\n    modalForm.show();\n}\n\n/**\n * Show modal form for tags bulk actions\n *\n * @param {Element} actionSelect\n * @param {Element} reportElement\n * @param {Object} args\n * @param {String} title\n */\nfunction showTagsModalForm(actionSelect, reportElement, args, title) {\n\n    const modalForm = new ModalForm({\n        modalConfig: {title},\n        formClass: 'tool_wsmanager\\\\form\\\\change_tags_form',\n        args,\n        saveButtonText: getString('savechanges', 'moodle'),\n        returnFocus: actionSelect,\n    });\n\n    // Reload report when the form is submitted.\n    modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, () => {\n        dispatchEvent(reportEvents.tableReload, {preservePagination: true}, reportElement);\n    });\n\n    modalForm.show();\n}\n\n/**\n * View function details in a modal\n *\n * @param {Element} targetElement\n */\nasync function showFunctionDetails(targetElement) {\n    const functionname = targetElement.dataset.function;\n\n    const paramsDesc = hightlighInJson(targetElement.dataset.parametersDesc);\n    const title1 = await getString('functionparameters', 'tool_wsmanager');\n    const returnDesc = hightlighInJson(targetElement.dataset.returnDesc);\n    const title2 = await getString('functionreturns', 'tool_wsmanager');\n\n    await Modal.create({\n            title: functionname,\n            large: true,\n            removeOnClose: true,\n            returnElement: targetElement,\n            show: true,\n            body:\n            '<p><strong>' + title1 + ':</strong></p>' +\n            '<pre>' + paramsDesc + '</pre>' +\n            '<p><strong>' + title2 + ':</strong></p>' +\n            '<pre>' + returnDesc + '</pre>',\n        });\n}\n\n/**\n * Highlight keys in a JSON string\n *\n * @param {String} jsonString\n * @returns {String} formatted JSON with highlighted keys\n */\nfunction hightlighInJson(jsonString) {\n    if (!jsonString) {\n        return '';\n    }\n    const doHighlight = function(v, parentKey = null) {\n        if (typeof v === 'object' && v !== null) {\n            const v2 = {};\n            for (const key of Object.keys(v)) {\n                const newKey = (parentKey === 'keys') ? '<strong class=\"key\">' + key + '</strong>' : key;\n                const newValue = key === 'desc' ? '<strong class=\"desc\">' + v[key] + '</strong>' : doHighlight(v[key], key);\n                v2[newKey] = newValue;\n            }\n            return v2;\n        }\n        return v;\n    };\n\n    const value = JSON.parse(jsonString);\n    const newValue = doHighlight(value, null);\n\n    return JSON.stringify(newValue, null, 2);\n}"],"names":["document","addEventListener","event","editServices","target","closest","SELECTORS","preventDefault","showFunctionModalForm","editDescription","viewDetails","targetElement","functionname","dataset","function","paramsDesc","hightlighInJson","parametersDesc","title1","returnDesc","title2","Modal","create","title","large","removeOnClose","returnElement","show","body","showFunctionDetails","bulkForm","querySelector","reportElement","_bulkForm$closest","reportSelectors","regions","report","actionSelect","value","functionNames","querySelectorAll","map","v","length","actionValue","arr","match","request","methodname","args","functionnames","serviceid","parseInt","action","call","then","reportEvents","tableReload","preservePagination","catch","e","Notification","exception","showTagsModalForm","join","performBulkAction","formClass","modalForm","ModalForm","modalConfig","saveButtonText","returnFocus","events","FORM_SUBMITTED","jsonString","doHighlight","parentKey","v2","key","Object","keys","newKey","newValue","JSON","parse","stringify"],"mappings":"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"}